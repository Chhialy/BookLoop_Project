name: Download Figma Assets

on:
  workflow_dispatch:

jobs:
  fetch-assets:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Figma asset downloader
        shell: powershell
        env:
          FIGMA_API_TOKEN: ${{ secrets.FIGMA_API_TOKEN }}
        run: |
          $fileKey = '${{ github.event.inputs.file_key || '' }}'
          $nodeIds = '${{ github.event.inputs.node_ids || '' }}'
          $outDir = 'mobile/flutter/assets'
          if (-not $env:FIGMA_API_TOKEN) {
            Write-Error "Missing FIGMA_API_TOKEN secret. Add it to repository secrets."
            exit 1
          }
          powershell -ExecutionPolicy Bypass -File .\tools\download_figma_assets.ps1 -fileKey $fileKey -nodeIds $nodeIds -outDir $outDir

      - name: Commit downloaded assets
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          git add mobile/flutter/assets || true
          git commit -m "chore: add Figma assets (automated)" || echo "No changes to commit"
          git push origin HEAD:refs/heads/feat/figma-assets || echo "Push failed"
